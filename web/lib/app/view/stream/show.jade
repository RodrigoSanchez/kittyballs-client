extends ../layout

block title
  = "Streaming"

block content
  #stream(data-session-id=sessionId, data-api-key=apiKey, data-token=token)

  script(
    src="http://static.opentok.com/webrtc/v2.0/js/TB.min.js",
    type="text/javascript"
  )

  script(type="text/javascript")
    $(document).ready(function() {
      var apiKey = $('#stream').attr('data-api-key');
      var sessionId = $('#stream').attr('data-session-id');
      var token = $('#stream').attr('data-token');
      var session = TB.initSession(sessionId);
      session.connect(apiKey, token);
      session.addEventListener('sessionConnected', sessionConnectedHandler);

      function sessionConnectedHandler(e) {
         subscribeToStreams(e.streams);
      }

      function subscribeToStreams(streams) {
        for (i = 0; i < streams.length; i++) {
          var stream = streams[i];
          if (stream.connection.connectionId != session.connection.connectionId) {
            console.log('hi')   
            session.subscribe(stream, '#stream');
          }
        }
      }

      function streamCreatedHandler(e) {
        subscribeToStreams(e.streams);
      }
    });
