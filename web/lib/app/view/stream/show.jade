extends ../layout

block title
  = "Streaming"

block content
  #stream(data-session-id=sessionId, data-api-key=apiKey, data-token=token)

  script(
    src="http://static.opentok.com/webrtc/v2.0/js/TB.min.js",
    type="text/javascript"
  )
  script(
    id='socketio',
    src="http://" + hostname + ":5001/socket.io/socket.io.js",
    type="text/javascript",
    data-url="http://" + hostname + ":5001/")

  script(type="text/javascript")
    $(document).ready(function() {
      var apiKey = $('#stream').attr('data-api-key');
      var sessionId = $('#stream').attr('data-session-id');
      var token = $('#stream').attr('data-token');
      var socketURL = $('#socketio').attr('data-url');
      var session = TB.initSession(sessionId);

      session.connect(apiKey, token);
      session.addEventListener('sessionConnected', sessionConnectedHandler);

      function sessionConnectedHandler(e) {
         subscribeToStreams(e.streams);
      }

      function subscribeToStreams(streams) {
        for (i = 0; i < streams.length; i++) {
          var stream = streams[i];
          if (stream.connection.connectionId != session.connection.connectionId) {
            console.log('hi')   
            session.subscribe(stream, '#stream');
          }
        }
      }

      function streamCreatedHandler(e) {
        subscribeToStreams(e.streams);
      }

      // Controls
      console.log(socketURL)
      var socket = io.connect(socketURL);
      console.log(socket)
      socket.on('connected', function(data) {
        $(document).keypress(function(e) {
          var keyCode = (e.keyCode ? e.keyCode : e.which);
          console.log(keyCode)
          if (keyCode == 100) {
            // Right
          } else if (keyCode == 120) {
            // Down
            console.log('down');
            socket.emit('message', { action: 'back' });
          } else if (keyCode == 119) {
            // Up
            console.log('roll')
            socket.emit('message', { action: 'roll' });
          } else if (keyCode == 115) {
            // Left
            socket.emit('message', { action: 'data' });
          } else if (keyCode == 32) {
            // Space
            socket.emit('message', { action: 'color' });
          }
        });
      });
    });
